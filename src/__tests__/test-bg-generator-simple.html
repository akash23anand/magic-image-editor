<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BG Generator Test - Simple</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-case {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        canvas {
            border: 1px solid #ddd;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        h3 {
            margin-top: 0;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>BG Generator Test - Demonstrating the Fix</h1>
    
    <div class="controls">
        <h3>Test Controls</h3>
        <input type="text" id="promptInput" placeholder="Enter background prompt (e.g., 'blue sky with clouds')" value="blue sky with clouds">
        <button onclick="testOldImplementation()">Test OLD Implementation (Issue)</button>
        <button onclick="testNewImplementation()">Test NEW Implementation (Fixed)</button>
        <button onclick="testComparison()">Compare Both</button>
    </div>

    <div id="status" class="status info">Ready to test</div>

    <div class="container" id="results"></div>

    <script>
        // Create a test image
        function createTestImage() {
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');
            
            // Draw a white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw a red rectangle (subject)
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(150, 100, 100, 100);
            
            // Add some text
            ctx.fillStyle = '#000000';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Test Subject', 200, 50);
            
            return ctx.getImageData(0, 0, canvas.width, canvas.height);
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function displayResult(title, imageData, metadata) {
            const container = document.getElementById('results');
            const testCase = document.createElement('div');
            testCase.className = 'test-case';
            
            const canvas = document.createElement('canvas');
            canvas.width = imageData.width;
            canvas.height = imageData.height;
            const ctx = canvas.getContext('2d');
            ctx.putImageData(imageData, 0, 0);
            
            testCase.innerHTML = `
                <h3>${title}</h3>
                <div id="canvas-${Date.now()}"></div>
                <pre>${JSON.stringify(metadata, null, 2)}</pre>
            `;
            
            testCase.querySelector('div').appendChild(canvas);
            container.appendChild(testCase);
        }

        // OLD implementation (with the issue)
        function createFallbackBackgroundOld(imageData, prompt) {
            const canvas = document.createElement('canvas');
            canvas.width = imageData.width;
            canvas.height = imageData.height;
            const ctx = canvas.getContext('2d');

            const promptLower = prompt.toLowerCase();
            const colors = extractColorsFromPrompt(promptLower);
            
            // Create gradient
            let gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            colors.forEach((color, index) => {
                gradient.addColorStop(index / (colors.length - 1), color);
            });

            // Fill background
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // THIS IS THE PROBLEM: Drawing original image on top with high opacity
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = imageData.width;
            tempCanvas.height = imageData.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.putImageData(imageData, 0, 0);
            
            ctx.globalAlpha = 0.9; // Almost opaque - hides the background!
            ctx.drawImage(tempCanvas, 0, 0);
            
            return {
                imageData: ctx.getImageData(0, 0, canvas.width, canvas.height),
                metadata: {
                    implementation: 'OLD - Problematic',
                    issue: 'Original image drawn at 0.9 opacity covers the new background',
                    prompt: prompt,
                    colors: colors
                }
            };
        }

        // NEW implementation (fixed)
        function createFallbackBackgroundNew(imageData, prompt) {
            const canvas = document.createElement('canvas');
            canvas.width = imageData.width;
            canvas.height = imageData.height;
            const ctx = canvas.getContext('2d');

            const promptLower = prompt.toLowerCase();
            const colors = extractColorsFromPrompt(promptLower);
            
            // Create gradient (with radial option)
            let gradient;
            if (promptLower.includes('radial') || promptLower.includes('center')) {
                gradient = ctx.createRadialGradient(
                    canvas.width / 2, canvas.height / 2, 0,
                    canvas.width / 2, canvas.height / 2, Math.max(canvas.width, canvas.height) / 2
                );
            } else {
                gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            }
            
            colors.forEach((color, index) => {
                gradient.addColorStop(index / (colors.length - 1), color);
            });

            // Fill background
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Add texture if requested
            if (promptLower.includes('texture') || promptLower.includes('noise')) {
                const noiseData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = noiseData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const noise = (Math.random() - 0.5) * 20;
                    data[i] = Math.max(0, Math.min(255, data[i] + noise));
                    data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noise));
                    data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noise));
                }
                ctx.putImageData(noiseData, 0, 0);
            }

            // FIXED: Just return the generated background without the original image
            return {
                imageData: ctx.getImageData(0, 0, canvas.width, canvas.height),
                metadata: {
                    implementation: 'NEW - Fixed',
                    fix: 'Returns only the generated background, ready for compositing',
                    prompt: prompt,
                    colors: colors,
                    type: promptLower.includes('radial') ? 'radial' : 'linear'
                }
            };
        }

        function extractColorsFromPrompt(prompt) {
            const colorMap = {
                'sky': ['#87CEEB', '#E0F6FF', '#FFFFFF'],
                'blue': ['#1e3c72', '#2a5298', '#7e8ba3'],
                'sunset': ['#ff7e5f', '#feb47b', '#ffcd94'],
                'sunrise': ['#f83600', '#f9d423', '#ffeb3b'],
                'ocean': ['#1a2980', '#26d0ce', '#7de2fc'],
                'purple': ['#667eea', '#764ba2', '#f093fb'],
                'pink': ['#ff9a9e', '#fecfef', '#fecfef'],
                'warm': ['#ffecd2', '#fcb69f', '#ff9a9e'],
                'cool': ['#a8edea', '#fed6e3', '#d299c2'],
                'dark': ['#2c3e50', '#34495e', '#7f8c8d'],
                'fire': ['#ff0000', '#ff4500', '#ffd700'],
                'clouds': ['#ffffff', '#f0f0f0', '#e0e0e0', '#d0d0d0']
            };

            for (const [keyword, colors] of Object.entries(colorMap)) {
                if (prompt.includes(keyword)) {
                    return colors;
                }
            }

            return ['#f5f5f5', '#e0e0e0', '#cccccc'];
        }

        function testOldImplementation() {
            document.getElementById('results').innerHTML = '';
            const prompt = document.getElementById('promptInput').value;
            const testImage = createTestImage();
            
            updateStatus('Testing OLD implementation (with issue)...', 'info');
            const result = createFallbackBackgroundOld(testImage, prompt);
            displayResult('OLD Implementation - Background Hidden by Original Image', result.imageData, result.metadata);
            updateStatus('OLD implementation tested - Notice how the background is barely visible!', 'error');
        }

        function testNewImplementation() {
            document.getElementById('results').innerHTML = '';
            const prompt = document.getElementById('promptInput').value;
            const testImage = createTestImage();
            
            updateStatus('Testing NEW implementation (fixed)...', 'info');
            const result = createFallbackBackgroundNew(testImage, prompt);
            displayResult('NEW Implementation - Clean Background Generation', result.imageData, result.metadata);
            updateStatus('NEW implementation tested - Background is properly generated!', 'success');
        }

        function testComparison() {
            document.getElementById('results').innerHTML = '';
            const prompt = document.getElementById('promptInput').value;
            const testImage = createTestImage();
            
            updateStatus('Comparing both implementations...', 'info');
            
            // Test OLD
            const oldResult = createFallbackBackgroundOld(testImage, prompt);
            displayResult('OLD: Background Hidden', oldResult.imageData, oldResult.metadata);
            
            // Test NEW
            const newResult = createFallbackBackgroundNew(testImage, prompt);
            displayResult('NEW: Background Visible', newResult.imageData, newResult.metadata);
            
            // Show how to properly composite
            const compositeCanvas = document.createElement('canvas');
            compositeCanvas.width = testImage.width;
            compositeCanvas.height = testImage.height;
            const compositeCtx = compositeCanvas.getContext('2d');
            
            // First draw the new background
            compositeCtx.putImageData(newResult.imageData, 0, 0);
            
            // Then extract and draw the subject (simple white removal)
            const subjectCanvas = document.createElement('canvas');
            subjectCanvas.width = testImage.width;
            subjectCanvas.height = testImage.height;
            const subjectCtx = subjectCanvas.getContext('2d');
            subjectCtx.putImageData(testImage, 0, 0);
            
            // Simple subject extraction (remove white background)
            const subjectData = subjectCtx.getImageData(0, 0, testImage.width, testImage.height);
            const data = subjectData.data;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Simple white detection
                if (r > 240 && g > 240 && b > 240) {
                    data[i + 3] = 0; // Make transparent
                }
            }
            subjectCtx.putImageData(subjectData, 0, 0);
            
            // Draw subject on new background
            compositeCtx.drawImage(subjectCanvas, 0, 0);
            
            displayResult('Proper Composite: Subject + New Background', 
                compositeCtx.getImageData(0, 0, testImage.width, testImage.height), 
                {
                    implementation: 'Proper Composite',
                    description: 'This shows how the background should be used with extracted subject',
                    steps: [
                        '1. Generate new background',
                        '2. Extract subject from original (remove background)',
                        '3. Composite subject onto new background'
                    ]
                }
            );
            
            updateStatus('Comparison complete - See the difference!', 'success');
        }

        // Initialize
        window.onload = () => {
            updateStatus('Ready to test. Try different prompts like "blue sky", "sunset", "ocean", "fire", etc.', 'success');
        };
    </script>
</body>
</html>